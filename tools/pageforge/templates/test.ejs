/**
* Tests for <%= spec.title %>
    * Auto-generated by PageForge
    */

    import { describe, it, expect, beforeEach, afterEach } from '@jest/globals';
    import request from 'supertest';
    import { app } from '../server/app';

    describe('<%= pascalCase(spec.id) %> API', () => {
        let authToken: string;
        let testId: string;

        beforeEach(async () => {
        // Get auth token for testing
        const loginResponse = await request(app)
        .post('/api/v1/auth/simple-login')
        .send({
        phone: '9654604148',
        otp: '123456'
        });

        authToken = loginResponse.body.accessJwt;
        });

        afterEach(async () => {
        // Clean up test data
        <% if (spec.api && spec.api.base) { %>
            if (testId) {
            await request(app)
            .delete(`<%= spec.api.base %>/${testId}`)
                .set('Authorization', `Bearer ${authToken}`);
                }
                <% } %>
                    });

                    describe('Health Check', () => {
                    it('should return health status', async () => {
                    <% if (spec.api && spec.api.base) { %>
                        const response = await request(app)
                        .get('<%= spec.api.base %>/health');

                            expect(response.status).toBe(200);
                            expect(response.body.ok).toBe(true);
                            expect(response.body.service).toBe('<%= kebabCase(spec.id) %>');
                                <% } else { %>
                                    // No API endpoint - skip test
                                    expect(true).toBe(true);
                                    <% } %>
                                        });
                                        });

                                        <% if (spec.api && spec.api.endpoints) { %>
                                            <% spec.api.endpoints.forEach(endpoint=> { %>
                                                describe('<%= endpoint.method %>
                                                    <%= endpoint.path %>', () => {
                                                        <% if (endpoint.method==='GET' ) { %>
                                                            it('should fetch data successfully', async () => {
                                                            const response = await request(app)
                                                            .get('<%= spec.api.base %>
                                                                <%= endpoint.path %>')
                                                                    .set('Authorization', `Bearer ${authToken}`);

                                                                    expect(response.status).toBe(200);
                                                                    expect(response.body.ok).toBe(true);
                                                                    expect(Array.isArray(response.body.data)).toBe(true);
                                                                    });
                                                                    <% } else if (endpoint.method==='POST' ) { %>
                                                                        it('should create item successfully', async ()
                                                                        => {
                                                                        const testData = {
                                                                        <% spec.entities[0].fields.forEach(field=> { %>
                                                                            <% if (field.required) { %>
                                                                                <%= field.key %>: <%=
                                                                                        getTestValue(field) %>,
                                                                                        <% } %>
                                                                                            <% }); %>
                                                                                                };

                                                                                                const response = await
                                                                                                request(app)
                                                                                                .post('<%= spec.api.base
                                                                                                    %>
                                                                                                    <%= endpoint.path %>
                                                                                                        ')
                                                                                                        .set('Authorization',
                                                                                                        `Bearer
                                                                                                        ${authToken}`)
                                                                                                        .send(testData);

                                                                                                        expect(response.status).toBe(200);
                                                                                                        expect(response.body.ok).toBe(true);
                                                                                                        expect(response.body.data).toBeDefined();

                                                                                                        testId =
                                                                                                        response.body.data.id;
                                                                                                        });

                                                                                                        it('should
                                                                                                        validate
                                                                                                        required
                                                                                                        fields', async
                                                                                                        () => {
                                                                                                        const response =
                                                                                                        await
                                                                                                        request(app)
                                                                                                        .post('<%=
                                                                                                            spec.api.base
                                                                                                            %>
                                                                                                            <%= endpoint.path
                                                                                                                %>')
                                                                                                                .set('Authorization',
                                                                                                                `Bearer
                                                                                                                ${authToken}`)
                                                                                                                .send({});

                                                                                                                expect(response.status).toBe(400);
                                                                                                                expect(response.body.ok).toBe(false);
                                                                                                                expect(response.body.error).toBe('Validation
                                                                                                                error');
                                                                                                                });
                                                                                                                <% } else
                                                                                                                    if
                                                                                                                    (endpoint.method==='PUT'
                                                                                                                    ) {
                                                                                                                    %>
                                                                                                                    it('should
                                                                                                                    update
                                                                                                                    item
                                                                                                                    successfully',
                                                                                                                    async
                                                                                                                    ()
                                                                                                                    => {
                                                                                                                    //
                                                                                                                    First
                                                                                                                    create
                                                                                                                    an
                                                                                                                    item
                                                                                                                    const
                                                                                                                    createData
                                                                                                                    = {
                                                                                                                    <%
                                                                                                                        spec.entities[0].fields.forEach(field=>
                                                                                                                        {
                                                                                                                        %>
                                                                                                                        <% if
                                                                                                                            (field.required)
                                                                                                                            {
                                                                                                                            %>
                                                                                                                            <%= field.key
                                                                                                                                %>
                                                                                                                                :
                                                                                                                                <%= getTestValue(field)
                                                                                                                                    %>
                                                                                                                                    ,
                                                                                                                                    <% }
                                                                                                                                        %>
                                                                                                                                        <% });
                                                                                                                                            %>
                                                                                                                                            };

                                                                                                                                            const
                                                                                                                                            createResponse
                                                                                                                                            =
                                                                                                                                            await
                                                                                                                                            request(app)
                                                                                                                                            .post('
                                                                                                                                            <%= spec.api.base
                                                                                                                                                %>
                                                                                                                                                /')
                                                                                                                                                .set('Authorization',
                                                                                                                                                `Bearer
                                                                                                                                                ${authToken}`)
                                                                                                                                                .send(createData);

                                                                                                                                                testId
                                                                                                                                                =
                                                                                                                                                createResponse.body.data.id;

                                                                                                                                                //
                                                                                                                                                Then
                                                                                                                                                update
                                                                                                                                                it
                                                                                                                                                const
                                                                                                                                                updateData
                                                                                                                                                =
                                                                                                                                                {
                                                                                                                                                id:
                                                                                                                                                testId,
                                                                                                                                                <%
                                                                                                                                                    spec.entities[0].fields.forEach(field=>
                                                                                                                                                    {
                                                                                                                                                    %>
                                                                                                                                                    <% if
                                                                                                                                                        (field.type==='string'
                                                                                                                                                        )
                                                                                                                                                        {
                                                                                                                                                        %>
                                                                                                                                                        <%= field.key
                                                                                                                                                            %>
                                                                                                                                                            :
                                                                                                                                                            'Updated
                                                                                                                                                            <%= field.key
                                                                                                                                                                %>
                                                                                                                                                                ',
                                                                                                                                                                <% } else
                                                                                                                                                                    if
                                                                                                                                                                    (field.type==='number'
                                                                                                                                                                    )
                                                                                                                                                                    {
                                                                                                                                                                    %>
                                                                                                                                                                    <%= field.key
                                                                                                                                                                        %>
                                                                                                                                                                        :
                                                                                                                                                                        999,
                                                                                                                                                                        <% }
                                                                                                                                                                            %>
                                                                                                                                                                            <% });
                                                                                                                                                                                %>
                                                                                                                                                                                };

                                                                                                                                                                                const
                                                                                                                                                                                response
                                                                                                                                                                                =
                                                                                                                                                                                await
                                                                                                                                                                                request(app)
                                                                                                                                                                                .put('
                                                                                                                                                                                <%= spec.api.base
                                                                                                                                                                                    %>
                                                                                                                                                                                    /')
                                                                                                                                                                                    .set('Authorization',
                                                                                                                                                                                    `Bearer
                                                                                                                                                                                    ${authToken}`)
                                                                                                                                                                                    .send(updateData);

                                                                                                                                                                                    expect(response.status).toBe(200);
                                                                                                                                                                                    expect(response.body.ok).toBe(true);
                                                                                                                                                                                    expect(response.body.data).toBeDefined();
                                                                                                                                                                                    });
                                                                                                                                                                                    <% } else
                                                                                                                                                                                        if
                                                                                                                                                                                        (endpoint.method==='DELETE'
                                                                                                                                                                                        )
                                                                                                                                                                                        {
                                                                                                                                                                                        %>
                                                                                                                                                                                        it('should
                                                                                                                                                                                        delete
                                                                                                                                                                                        item
                                                                                                                                                                                        successfully',
                                                                                                                                                                                        async
                                                                                                                                                                                        ()
                                                                                                                                                                                        =>
                                                                                                                                                                                        {
                                                                                                                                                                                        //
                                                                                                                                                                                        First
                                                                                                                                                                                        create
                                                                                                                                                                                        an
                                                                                                                                                                                        item
                                                                                                                                                                                        const
                                                                                                                                                                                        createData
                                                                                                                                                                                        =
                                                                                                                                                                                        {
                                                                                                                                                                                        <%
                                                                                                                                                                                            spec.entities[0].fields.forEach(field=>
                                                                                                                                                                                            {
                                                                                                                                                                                            %>
                                                                                                                                                                                            <% if
                                                                                                                                                                                                (field.required)
                                                                                                                                                                                                {
                                                                                                                                                                                                %>
                                                                                                                                                                                                <%= field.key
                                                                                                                                                                                                    %>
                                                                                                                                                                                                    :
                                                                                                                                                                                                    <%= getTestValue(field)
                                                                                                                                                                                                        %>
                                                                                                                                                                                                        ,
                                                                                                                                                                                                        <% }
                                                                                                                                                                                                            %>
                                                                                                                                                                                                            <% });
                                                                                                                                                                                                                %>
                                                                                                                                                                                                                };

                                                                                                                                                                                                                const
                                                                                                                                                                                                                createResponse
                                                                                                                                                                                                                =
                                                                                                                                                                                                                await
                                                                                                                                                                                                                request(app)
                                                                                                                                                                                                                .post('
                                                                                                                                                                                                                <%= spec.api.base
                                                                                                                                                                                                                    %>
                                                                                                                                                                                                                    /')
                                                                                                                                                                                                                    .set('Authorization',
                                                                                                                                                                                                                    `Bearer
                                                                                                                                                                                                                    ${authToken}`)
                                                                                                                                                                                                                    .send(createData);

                                                                                                                                                                                                                    testId
                                                                                                                                                                                                                    =
                                                                                                                                                                                                                    createResponse.body.data.id;

                                                                                                                                                                                                                    //
                                                                                                                                                                                                                    Then
                                                                                                                                                                                                                    delete
                                                                                                                                                                                                                    it
                                                                                                                                                                                                                    const
                                                                                                                                                                                                                    response
                                                                                                                                                                                                                    =
                                                                                                                                                                                                                    await
                                                                                                                                                                                                                    request(app)
                                                                                                                                                                                                                    .delete(`
                                                                                                                                                                                                                    <%= spec.api.base
                                                                                                                                                                                                                        %>
                                                                                                                                                                                                                        /${testId}`)
                                                                                                                                                                                                                        .set('Authorization',
                                                                                                                                                                                                                        `Bearer
                                                                                                                                                                                                                        ${authToken}`);

                                                                                                                                                                                                                        expect(response.status).toBe(200);
                                                                                                                                                                                                                        expect(response.body.ok).toBe(true);
                                                                                                                                                                                                                        });
                                                                                                                                                                                                                        <% }
                                                                                                                                                                                                                            %>
                                                                                                                                                                                                                            });
                                                                                                                                                                                                                            <% });
                                                                                                                                                                                                                                %>
                                                                                                                                                                                                                                <% }
                                                                                                                                                                                                                                    %>

                                                                                                                                                                                                                                    <% if
                                                                                                                                                                                                                                        (spec.api
                                                                                                                                                                                                                                        &&
                                                                                                                                                                                                                                        spec.api.base)
                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                        %>
                                                                                                                                                                                                                                        describe('Authentication',
                                                                                                                                                                                                                                        ()
                                                                                                                                                                                                                                        =>
                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                        it('should
                                                                                                                                                                                                                                        require
                                                                                                                                                                                                                                        authentication
                                                                                                                                                                                                                                        for
                                                                                                                                                                                                                                        protected
                                                                                                                                                                                                                                        routes',
                                                                                                                                                                                                                                        async
                                                                                                                                                                                                                                        ()
                                                                                                                                                                                                                                        =>
                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                        const
                                                                                                                                                                                                                                        response
                                                                                                                                                                                                                                        =
                                                                                                                                                                                                                                        await
                                                                                                                                                                                                                                        request(app)
                                                                                                                                                                                                                                        .get('
                                                                                                                                                                                                                                        <%= spec.api.base
                                                                                                                                                                                                                                            %>
                                                                                                                                                                                                                                            /list');

                                                                                                                                                                                                                                            expect(response.status).toBe(401);
                                                                                                                                                                                                                                            expect(response.body.ok).toBe(false);
                                                                                                                                                                                                                                            expect(response.body.error).toBe('Access
                                                                                                                                                                                                                                            token
                                                                                                                                                                                                                                            required');
                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                            <% }
                                                                                                                                                                                                                                                %>
                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                //
                                                                                                                                                                                                                                                Helper
                                                                                                                                                                                                                                                functions
                                                                                                                                                                                                                                                function
                                                                                                                                                                                                                                                getTestValue(field:
                                                                                                                                                                                                                                                any):
                                                                                                                                                                                                                                                string
                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                const
                                                                                                                                                                                                                                                valueMap:
                                                                                                                                                                                                                                                Record
                                                                                                                                                                                                                                                <string,
                                                                                                                                                                                                                                                    string>
                                                                                                                                                                                                                                                    =
                                                                                                                                                                                                                                                    {
                                                                                                                                                                                                                                                    'string':
                                                                                                                                                                                                                                                    '"Test
                                                                                                                                                                                                                                                    Value"',
                                                                                                                                                                                                                                                    'number':
                                                                                                                                                                                                                                                    '123',
                                                                                                                                                                                                                                                    'boolean':
                                                                                                                                                                                                                                                    'true',
                                                                                                                                                                                                                                                    'datetime':
                                                                                                                                                                                                                                                    '"2025-09-14T12:00:00Z"',
                                                                                                                                                                                                                                                    'time':
                                                                                                                                                                                                                                                    '"12:00:00"',
                                                                                                                                                                                                                                                    'date':
                                                                                                                                                                                                                                                    '"2025-09-14"',
                                                                                                                                                                                                                                                    'money':
                                                                                                                                                                                                                                                    '100.50',
                                                                                                                                                                                                                                                    'enum':
                                                                                                                                                                                                                                                    field.values
                                                                                                                                                                                                                                                    &&
                                                                                                                                                                                                                                                    field.values.length
                                                                                                                                                                                                                                                    >
                                                                                                                                                                                                                                                    0
                                                                                                                                                                                                                                                    ?
                                                                                                                                                                                                                                                    `"${field.values[0]}"`
                                                                                                                                                                                                                                                    :
                                                                                                                                                                                                                                                    '"VALUE"',
                                                                                                                                                                                                                                                    'array
                                                                                                                                                                                                                                                    <string>
                                                                                                                                                                                                                                                        ':
                                                                                                                                                                                                                                                        '["item1",
                                                                                                                                                                                                                                                        "item2"]'
                                                                                                                                                                                                                                                        };
                                                                                                                                                                                                                                                        return
                                                                                                                                                                                                                                                        valueMap[field.type]
                                                                                                                                                                                                                                                        ||
                                                                                                                                                                                                                                                        'null';
                                                                                                                                                                                                                                                        }